<div class="order-details-page">
  <div class="order-details-wrapper">
    <!-- Breadcrumb -->
    <div class="breadcrumb-section">
      <a href="/">Home</a>
      <span>/</span>
      <a href="/account?tab=orders">My Orders</a>
      <span>/</span>
      <span>Order #<%= order.number || order._id.toString().slice(-8).toUpperCase() %></span>
    </div>

    <!-- Order Header -->
    <div class="order-header-section">
      <div class="order-header-content">
        <div class="order-title-group">
          <h1 class="order-main-title">Order #<%= order.number || order._id.toString().slice(-8).toUpperCase() %></h1>
          <p class="order-date-text">Placed on <%= new Date(order.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></p>
        </div>
        <span class="order-status-badge <%= order.status.toLowerCase() %>">
          <%= order.status.charAt(0).toUpperCase() + order.status.slice(1) %>
        </span>
      </div>
    </div>

    <!-- Order Progress Tracker -->
    <div class="order-progress-container">
      <div class="progress-tracker">
        <div class="progress-step <%= ['pending', 'processing', 'shipped', 'delivered'].includes(order.status.toLowerCase()) ? 'active' : '' %>">
          <div class="step-icon-wrapper">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
            </svg>
          </div>
          <span class="step-label">Order Placed</span>
        </div>
        <div class="progress-connector <%= ['processing', 'shipped', 'delivered'].includes(order.status.toLowerCase()) ? 'active' : '' %>"></div>
        <div class="progress-step <%= ['processing', 'shipped', 'delivered'].includes(order.status.toLowerCase()) ? 'active' : '' %>">
          <div class="step-icon-wrapper">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
          </div>
          <span class="step-label">Processing</span>
        </div>
        <div class="progress-connector <%= ['shipped', 'delivered'].includes(order.status.toLowerCase()) ? 'active' : '' %>"></div>
        <div class="progress-step <%= ['shipped', 'delivered'].includes(order.status.toLowerCase()) ? 'active' : '' %>">
          <div class="step-icon-wrapper">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
          <span class="step-label">Shipped</span>
        </div>
        <div class="progress-connector <%= ['delivered'].includes(order.status.toLowerCase()) ? 'active' : '' %>"></div>
        <div class="progress-step <%= ['delivered'].includes(order.status.toLowerCase()) ? 'active' : '' %>">
          <div class="step-icon-wrapper">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <span class="step-label">Delivered</span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="order-content-container">
      <!-- Order Items Section -->
      <div class="order-items-section">
        <h2 class="section-title-main">Order Items</h2>
        
        <div class="items-list-container">
          <% (order.items || []).forEach(item => { %>
            <div class="order-item-card">
              <div class="item-image-container">
                <% if (item.image) { %>
                  <img src="<%= item.image %>" alt="<%= item.titleSnapshot || 'Book' %>" class="item-image" />
                <% } else { %>
                  <div class="item-placeholder">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                  </div>
                <% } %>
              </div>
              <div class="item-info-container">
                <h3 class="item-title-text"><%= item.titleSnapshot %></h3>
                <div class="item-meta-info">
                  <span class="item-quantity">Quantity: <%= item.qty %></span>
                  <span class="item-unit-price"><%= store.currency %> <%= (item.priceAtPurchase || 0).toFixed(2) %></span>
                </div>
              </div>
              <div class="item-total-price">
                <%= store.currency %> <%= ((item.priceAtPurchase || 0) * item.qty).toFixed(2) %>
              </div>
            </div>
          <% }); %>
        </div>

        <!-- Order Summary -->
        <div class="order-summary-container">
          <div class="summary-row-item">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value"><%= store.currency %> <%= (order.totals && order.totals.subtotal) ? order.totals.subtotal.toFixed(2) : '0.00' %></span>
          </div>
          <% if (order.totals && order.totals.shipping && order.totals.shipping > 0) { %>
            <div class="summary-row-item">
              <span class="summary-label">Shipping</span>
              <span class="summary-value"><%= store.currency %> <%= order.totals.shipping.toFixed(2) %></span>
            </div>
          <% } %>
          <% if (order.totals && order.totals.discountTotal && order.totals.discountTotal > 0) { %>
            <div class="summary-row-item summary-discount">
              <span class="summary-label">Discount</span>
              <span class="summary-value">- <%= store.currency %> <%= order.totals.discountTotal.toFixed(2) %></span>
            </div>
          <% } %>
          <div class="summary-row-item summary-total">
            <span class="summary-label">Total</span>
            <span class="summary-value-total"><%= store.currency %> <%= (order.totals && order.totals.grandTotal) ? order.totals.grandTotal.toFixed(2) : '0.00' %></span>
          </div>
        </div>
      </div>

      <!-- Info Cards Section -->
      <div class="info-cards-section">
        <!-- Delivery Information -->
        <div class="info-card-wrapper">
          <h3 class="info-card-title-main">Delivery Information</h3>
          <div class="info-card-content">
            <% if (order.customer && order.customer.name) { %>
              <div class="info-row">
                <span class="info-label-text">Name</span>
                <span class="info-value-text"><%= order.customer.name %></span>
              </div>
              <div class="info-row">
                <span class="info-label-text">Address</span>
                <span class="info-value-text">
                  <%= order.customer.address1 %><br/>
                  <% if (order.customer.address2) { %><%= order.customer.address2 %><br/><% } %>
                  <%= order.customer.city %><% if (order.customer.state) { %>, <%= order.customer.state %><% } %> <%= order.customer.postalCode %><br/>
                  <%= order.customer.country || 'Nepal' %>
                </span>
              </div>
              <% if (order.customer.phone) { %>
                <div class="info-row">
                  <span class="info-label-text">Phone</span>
                  <span class="info-value-text"><%= order.customer.phone %></span>
                </div>
              <% } %>
              <% if (order.customer.email) { %>
                <div class="info-row">
                  <span class="info-label-text">Email</span>
                  <span class="info-value-text"><%= order.customer.email %></span>
                </div>
              <% } %>
            <% } else { %>
              <p class="no-info-message">Delivery information not available</p>
            <% } %>
          </div>
        </div>

        <!-- Payment Information -->
        <div class="info-card-wrapper">
          <h3 class="info-card-title-main">Payment Information</h3>
          <div class="info-card-content">
            <div class="info-row">
              <span class="info-label-text">Method</span>
              <span class="info-value-text">
                <% if (order.payment && order.payment.method) { %>
                  <%= order.payment.method === 'COD' ? 'Cash on Delivery' : order.payment.method %>
                <% } else { %>
                  N/A
                <% } %>
              </span>
            </div>
            <div class="info-row">
              <span class="info-label-text">Status</span>
              <span class="info-value-text">
                <% if (order.payment && order.payment.status) { %>
                  <span class="payment-status-badge <%= order.payment.status %>">
                    <%= order.payment.status.charAt(0).toUpperCase() + order.payment.status.slice(1) %>
                  </span>
                <% } else { %>
                  <span class="payment-status-badge unpaid">Pending</span>
                <% } %>
              </span>
            </div>
            <% if (order.payment && order.payment.transactionId) { %>
              <div class="info-row">
                <span class="info-label-text">Transaction ID</span>
                <span class="info-value-text"><%= order.payment.transactionId %></span>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Actions -->
        <div class="order-actions-container">
          <% if (order.status.toLowerCase() === 'pending' || order.status.toLowerCase() === 'processing') { %>
            <button class="action-button action-cancel" type="button" data-order-id="<%= order._id %>">
              Cancel Order
            </button>
          <% } %>
          <a href="/account?tab=orders" class="action-button action-back">
            Back to Orders
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Order Details Page - Mobile First */
.order-details-page {
  background: #f8f6f2;
  padding: 16px 0 100px;
  min-height: calc(100vh - 200px);
}

.order-details-wrapper {
  max-width: 1280px;
  margin: 0 auto;
  padding: 0 16px;
}

/* Breadcrumb */
.breadcrumb-section {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
  font-size: 13px;
  color: rgba(13, 13, 15, 0.6);
}

.breadcrumb-section a {
  color: rgba(13, 13, 15, 0.6);
  text-decoration: none;
  transition: color 0.2s ease;
}

.breadcrumb-section a:hover {
  color: #0d0d0f;
}

.breadcrumb-section span {
  color: rgba(13, 13, 15, 0.4);
}

/* Order Header */
.order-header-section {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 12px rgba(13, 13, 15, 0.08);
  border: 1px solid rgba(13, 13, 15, 0.08);
}

.order-header-content {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.order-title-group {
  flex: 1;
}

.order-main-title {
  font-family: 'Playfair Display', serif;
  font-size: 24px;
  font-weight: 700;
  color: #0d0d0f;
  margin-bottom: 6px;
  line-height: 1.2;
}

.order-date-text {
  font-size: 14px;
  color: rgba(13, 13, 15, 0.6);
}

.order-status-badge {
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  text-transform: capitalize;
  align-self: flex-start;
}

.order-status-badge.pending {
  background: rgba(241, 196, 15, 0.1);
  color: #f39c12;
}

.order-status-badge.processing {
  background: rgba(52, 152, 219, 0.1);
  color: #3498db;
}

.order-status-badge.shipped {
  background: rgba(155, 89, 182, 0.1);
  color: #9b59b6;
}

.order-status-badge.delivered {
  background: rgba(46, 204, 113, 0.1);
  color: #27ae60;
}

.order-status-badge.cancelled,
.order-status-badge.returned {
  background: rgba(231, 76, 60, 0.1);
  color: #e74c3c;
}

/* Progress Tracker */
.order-progress-container {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 12px rgba(13, 13, 15, 0.08);
  border: 1px solid rgba(13, 13, 15, 0.08);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.progress-tracker {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: max-content;
}

.progress-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  flex: 0 0 auto;
  opacity: 0.3;
  transition: opacity 0.3s ease;
}

.progress-step.active {
  opacity: 1;
}

.step-icon-wrapper {
  width: 44px;
  height: 44px;
  background: rgba(13, 13, 15, 0.05);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(13, 13, 15, 0.4);
  transition: all 0.2s ease;
}

.progress-step.active .step-icon-wrapper {
  background: #0d0d0f;
  color: white;
  box-shadow: 0 2px 8px rgba(13, 13, 15, 0.15);
}

.step-label {
  font-size: 11px;
  font-weight: 600;
  text-align: center;
  white-space: nowrap;
  color: rgba(13, 13, 15, 0.6);
}

.progress-step.active .step-label {
  color: #0d0d0f;
}

.progress-connector {
  flex: 1;
  height: 2px;
  background: rgba(13, 13, 15, 0.1);
  min-width: 20px;
  max-width: 40px;
  transition: background 0.3s ease;
}

.progress-connector.active {
  background: #0d0d0f;
}

/* Order Content */
.order-content-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* Order Items Section */
.order-items-section {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 2px 12px rgba(13, 13, 15, 0.08);
  border: 1px solid rgba(13, 13, 15, 0.08);
}

.section-title-main {
  font-family: 'Playfair Display', serif;
  font-size: 22px;
  font-weight: 700;
  color: #0d0d0f;
  margin-bottom: 20px;
}

.items-list-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-bottom: 24px;
}

.order-item-card {
  display: flex;
  gap: 12px;
  padding: 16px;
  background: rgba(13, 13, 15, 0.02);
  border-radius: 12px;
  border: 1px solid rgba(13, 13, 15, 0.08);
}

.item-image-container {
  width: 60px;
  height: 80px;
  flex-shrink: 0;
  border-radius: 8px;
  overflow: hidden;
  background: rgba(13, 13, 15, 0.05);
}

.item-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.item-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: rgba(13, 13, 15, 0.3);
}

.item-placeholder svg {
  width: 24px;
  height: 24px;
}

.item-info-container {
  flex: 1;
  min-width: 0;
}

.item-title-text {
  font-size: 15px;
  font-weight: 600;
  color: #0d0d0f;
  margin-bottom: 8px;
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  -webkit-box-orient: vertical;
}

.item-meta-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 13px;
  color: rgba(13, 13, 15, 0.6);
}

.item-quantity {
  font-weight: 500;
}

.item-unit-price {
  font-weight: 500;
}

.item-total-price {
  font-size: 16px;
  font-weight: 700;
  color: #0d0d0f;
  white-space: nowrap;
  align-self: flex-start;
  padding-top: 4px;
  font-family: 'Playfair Display', serif;
}

/* Order Summary */
.order-summary-container {
  border-top: 2px solid rgba(13, 13, 15, 0.1);
  padding-top: 20px;
}

.summary-row-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  font-size: 15px;
}

.summary-label {
  color: rgba(13, 13, 15, 0.7);
  font-weight: 500;
}

.summary-value {
  color: #0d0d0f;
  font-weight: 600;
}

.summary-row-item.summary-discount {
  color: #27ae60;
}

.summary-row-item.summary-discount .summary-value {
  color: #27ae60;
}

.summary-row-item.summary-total {
  border-top: 2px solid rgba(13, 13, 15, 0.1);
  margin-top: 8px;
  padding-top: 16px;
}

.summary-total .summary-label {
  font-size: 18px;
  font-weight: 700;
  color: #0d0d0f;
}

.summary-value-total {
  font-size: 20px;
  font-weight: 700;
  color: #0d0d0f;
  font-family: 'Playfair Display', serif;
}

/* Info Cards Section */
.info-cards-section {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.info-card-wrapper {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 2px 12px rgba(13, 13, 15, 0.08);
  border: 1px solid rgba(13, 13, 15, 0.08);
}

.info-card-title-main {
  font-size: 18px;
  font-weight: 700;
  color: #0d0d0f;
  margin-bottom: 16px;
  font-family: 'Playfair Display', serif;
}

.info-card-content {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.info-row {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.info-label-text {
  font-size: 12px;
  font-weight: 600;
  color: rgba(13, 13, 15, 0.6);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.info-value-text {
  font-size: 15px;
  color: #0d0d0f;
  line-height: 1.6;
}

.payment-status-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  display: inline-block;
  text-transform: capitalize;
}

.payment-status-badge.pending,
.payment-status-badge.unpaid {
  background: rgba(241, 196, 15, 0.1);
  color: #f39c12;
}

.payment-status-badge.paid {
  background: rgba(46, 204, 113, 0.1);
  color: #27ae60;
}

.payment-status-badge.failed,
.payment-status-badge.refunded {
  background: rgba(231, 76, 60, 0.1);
  color: #e74c3c;
}

.no-info-message {
  color: rgba(13, 13, 15, 0.5);
  font-style: italic;
  font-size: 14px;
}

/* Order Actions */
.order-actions-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.action-button {
  padding: 14px 24px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 15px;
  text-align: center;
  text-decoration: none;
  transition: all 0.2s ease;
  border: none;
  cursor: pointer;
  touch-action: manipulation;
}

.action-cancel {
  background: rgba(231, 76, 60, 0.1);
  color: #e74c3c;
}

.action-cancel:hover {
  background: #e74c3c;
  color: white;
  box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
  transform: translateY(-1px);
}

.action-back {
  background: rgba(13, 13, 15, 0.05);
  color: #0d0d0f;
  border: 1px solid rgba(13, 13, 15, 0.1);
}

.action-back:hover {
  background: rgba(13, 13, 15, 0.1);
  border-color: rgba(13, 13, 15, 0.2);
  transform: translateY(-1px);
}

/* Responsive - Tablet and Desktop */
@media (min-width: 640px) {
  .order-details-page {
    padding: 32px 0 100px;
  }

  .order-details-wrapper {
    padding: 0 24px;
  }

  .breadcrumb-section {
    font-size: 14px;
    margin-bottom: 24px;
  }

  .order-header-section {
    padding: 32px;
  }

  .order-header-content {
    flex-direction: row;
    justify-content: space-between;
    align-items: flex-start;
  }

  .order-main-title {
    font-size: 32px;
  }

  .order-date-text {
    font-size: 16px;
  }

  .order-status-badge {
    align-self: center;
  }

  .order-progress-container {
    padding: 32px 40px;
  }

  .progress-tracker {
    justify-content: space-between;
  }

  .progress-step {
    gap: 12px;
  }

  .step-icon-wrapper {
    width: 56px;
    height: 56px;
  }

  .step-label {
    font-size: 13px;
  }

  .progress-connector {
    max-width: none;
  }

  .order-items-section {
    padding: 32px;
  }

  .section-title-main {
    font-size: 28px;
    margin-bottom: 24px;
  }

  .items-list-container {
    gap: 20px;
    margin-bottom: 32px;
  }

  .order-item-card {
    padding: 20px;
  }

  .item-image-container {
    width: 80px;
    height: 100px;
  }

  .item-title-text {
    font-size: 16px;
  }

  .item-meta-info {
    flex-direction: row;
    gap: 16px;
  }

  .item-total-price {
    font-size: 18px;
    align-self: center;
  }

  .order-summary-container {
    padding-top: 24px;
  }

  .summary-row-item {
    font-size: 16px;
    padding: 14px 0;
  }

  .summary-total .summary-label {
    font-size: 20px;
  }

  .summary-value-total {
    font-size: 24px;
  }

  .info-card-wrapper {
    padding: 32px;
  }

  .info-card-title-main {
    font-size: 20px;
    margin-bottom: 20px;
  }

  .info-card-content {
    gap: 20px;
  }

  .info-row {
    flex-direction: row;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
  }

  .info-label-text {
    font-size: 13px;
    min-width: 120px;
  }

  .info-value-text {
    font-size: 16px;
    text-align: right;
    flex: 1;
  }

  .order-content-container {
    gap: 32px;
  }
}

@media (min-width: 1024px) {
  .order-content-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 32px;
  }

  .info-cards-section {
    gap: 24px;
  }
}
</style>

<script>
(function() {
  'use strict';

  // Cancel Order Functionality
  function initCancelOrder() {
    const cancelButtons = document.querySelectorAll('.action-cancel');
    
    cancelButtons.forEach(button => {
      button.addEventListener('click', function() {
        const orderId = this.getAttribute('data-order-id');
        
        if (!orderId) return;
        
        if (confirm('Are you sure you want to cancel this order? This action cannot be undone.')) {
          fetch(`/orders/${orderId}/cancel`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.ok) {
              alert('Order cancelled successfully');
              window.location.reload();
            } else {
              alert(data.message || 'Failed to cancel order');
            }
          })
          .catch(error => {
            console.error('Cancel order error:', error);
            alert('Failed to cancel order. Please try again.');
          });
        }
      });
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCancelOrder);
  } else {
    initCancelOrder();
  }
})();
</script>
