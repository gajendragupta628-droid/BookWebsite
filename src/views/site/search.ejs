<div class="search-page">
  <!-- Mobile Filter Overlay -->
  <div class="mobile-filter-overlay" id="filterOverlay"></div>
  
  <!-- Mobile Filter Button -->
  <button class="mobile-filter-btn" id="filterBtn" type="button" aria-label="Open filters">
    <svg class="filter-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
    </svg>
  </button>

  <div class="container-custom">
    <div class="search-layout">
      <!-- Filters Sidebar -->
      <div class="search-sidebar" id="filterSidebar">
        <div class="filter-sidebar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid rgba(13, 13, 15, 0.1);">
          <h3 style="font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; color: #0d0d0f; margin: 0;">Filters</h3>
          <button id="closeFilterBtn" type="button" aria-label="Close filters" style="background: none; border: none; font-size: 32px; line-height: 1; cursor: pointer; padding: 4px 8px; color: rgba(13, 13, 15, 0.6); min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;">×</button>
        </div>
        <%- include('../partials/filters', { filters }) %>
      </div>

      <!-- Main Content -->
      <div class="search-content">
        <!-- Search Header -->
        <div class="search-header">
          <div class="search-header-top">
            <div class="search-info">
              <h1 class="search-title">
                <% if (q) { %>
                  Search results for "<%= q %>"
                <% } else if (filters && filters.category) { %>
                  Category: <%= filters.category %>
                <% } else { %>
                  All Books
                <% } %>
              </h1>
              <% if (total !== undefined) { %>
                <p class="search-count"><%= total %> <%= total === 1 ? 'book' : 'books' %> found</p>
              <% } %>
            </div>

            <!-- Sort Dropdown -->
            <div class="sort-dropdown">
              <label class="sort-label">Sort by:</label>
              <select onchange="changeSorting(this.value)" class="sort-select">
                <option value="relevance" <%= (!sort || sort === 'relevance') ? 'selected' : '' %>>Relevance</option>
                <option value="newest" <%= (sort === 'newest') ? 'selected' : '' %>>Newest First</option>
                <option value="price-low" <%= (sort === 'price-low') ? 'selected' : '' %>>Price: Low to High</option>
                <option value="price-high" <%= (sort === 'price-high') ? 'selected' : '' %>>Price: High to Low</option>
                <option value="title-asc" <%= (sort === 'title-asc') ? 'selected' : '' %>>Title: A to Z</option>
                <option value="popular" <%= (sort === 'popular') ? 'selected' : '' %>>Most Popular</option>
              </select>
            </div>
          </div>

          <!-- Active Filters Display -->
          <% 
            const activeFilters = [];
            if (filters) {
              if (filters.category) activeFilters.push({ label: `Category: ${filters.category}`, key: 'category' });
              if (filters.author) activeFilters.push({ label: `Author: ${filters.author}`, key: 'author' });
              if (filters.inStock) activeFilters.push({ label: 'In Stock', key: 'inStock' });
              if (filters.priceMin || filters.priceMax) activeFilters.push({ 
                label: `रू${filters.priceMin || '0'} - रू${filters.priceMax || '∞'}`, 
                key: 'price' 
              });
              if (filters.language) activeFilters.push({ label: filters.language, key: 'language' });
              if (filters.condition) activeFilters.push({ label: filters.condition, key: 'condition' });
            }
          %>
          <% if (activeFilters.length > 0) { %>
            <div class="active-filters">
              <span class="active-filters-label">Active Filters:</span>
              <div class="active-filters-tags">
                <% activeFilters.forEach(filter => { %>
                  <button class="filter-tag" onclick="removeFilter('<%= filter.key %>')">
                    <%= filter.label %>
                    <span class="filter-tag-remove">×</span>
                  </button>
                <% }); %>
                <button class="clear-all-filters" onclick="clearAllFilters()">
                  Clear All
                </button>
              </div>
            </div>
          <% } %>
        </div>

        <!-- Empty State -->
        <% if (!items || items.length === 0) { %>
          <div class="empty-state">
            <div class="empty-icon">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
            </div>
            <h3 class="empty-title">No books found</h3>
            <p class="empty-description">
              <% if (q) { %>
                We couldn't find any books matching "<strong><%= q %></strong>". Try adjusting your search or filters.
              <% } else { %>
                No books match your current filters. Try adjusting your selection.
              <% } %>
            </p>
            <div class="empty-actions">
              <button onclick="clearAllFilters()" class="btn-primary">Clear All Filters</button>
              <a href="/search" class="btn-secondary">Browse All Books</a>
            </div>
          </div>
        <% } else { %>
          <!-- Products Grid -->
          <div class="products-section">
            <div id="products-grid-container">
              <div class="product-grid">
                <% items.forEach(function(book){ %>
                  <%- include('../partials/product-card', { book: book, session, store }) %>
                <% }) %>
              </div>
            </div>

            <!-- Load More Button -->
            <% 
              const currentPage = page || 1;
              const totalPages = Math.ceil(total / perPage);
              const hasMore = currentPage < totalPages;
            %>
            <% if (hasMore) { %>
              <div class="load-more-wrapper">
                <button id="loadMoreBtn" class="load-more-btn" data-page="<%= currentPage %>" data-total-pages="<%= totalPages %>">
                  <span class="load-more-text">Load More</span>
                  <svg class="load-more-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </button>
              </div>
            <% } %>
          </div>
        <% } %>

        <!-- Popular Categories -->
        <div class="popular-categories">
          <h3 class="popular-categories-title">Browse by Category</h3>
          <div class="categories-grid">
            <% 
              const popularCats = [
                { name: 'Fiction', slug: 'fiction', icon: 'book' },
                { name: 'Self Help', slug: 'self-help', icon: 'star' },
                { name: 'Business', slug: 'business', icon: 'briefcase' },
                { name: 'Children', slug: 'children', icon: 'palette' },
                { name: 'Biography', slug: 'biography', icon: 'user' },
                { name: 'Science', slug: 'science', icon: 'flask' },
                { name: 'History', slug: 'history', icon: 'scroll' },
                { name: 'Cooking', slug: 'cooking', icon: 'utensils' }
              ];
            %>
            <% popularCats.forEach(cat => { %>
              <a href="/search?<%= q ? ('q=' + encodeURIComponent(q) + '&') : '' %>category=<%= encodeURIComponent(cat.name) %>" class="category-card">
                <span class="category-icon">
                  <% if (cat.icon === 'book') { %>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                  <% } else if (cat.icon === 'star') { %>
                    <svg fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                  <% } else if (cat.icon === 'briefcase') { %>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                  <% } else if (cat.icon === 'palette') { %>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                    </svg>
                  <% } else if (cat.icon === 'user') { %>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                  <% } else if (cat.icon === 'flask') { %>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                  <% } else if (cat.icon === 'scroll') { %>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  <% } else if (cat.icon === 'utensils') { %>
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                  <% } %>
                </span>
                <span class="category-name"><%= cat.name %></span>
              </a>
            <% }); %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Search Page Styles - Mobile First */
.search-page {
  background: #fafafa;
  padding: 16px 0 64px;
  min-height: 100vh;
}

@media (min-width: 640px) {
  .search-page {
    padding: 24px 0 80px;
  }
}

@media (min-width: 768px) {
  .search-page {
    padding: 40px 0 80px;
  }
}

.search-layout {
  display: grid;
  grid-template-columns: 1fr;
  gap: 32px;
  align-items: start;
}

@media (min-width: 768px) {
  .search-layout {
    grid-template-columns: 280px 1fr;
  }
}

@media (min-width: 1024px) {
  .search-layout {
    grid-template-columns: 320px 1fr;
  }
}

.search-sidebar {
  display: none;
}

.filter-sidebar-header {
  display: none; /* Hidden on desktop */
}

@media (min-width: 768px) {
  .search-sidebar {
    display: block;
  }
}

@media (max-width: 767px) {
  .filter-sidebar-header {
    display: flex !important; /* Show only on mobile */
  }
}

.search-content {
  display: flex;
  flex-direction: column;
  gap: 32px;
}

/* Search Header */
.search-header {
  background: white;
  border-radius: 12px;
  padding: 20px 16px;
  box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
  border: 1px solid rgba(0, 0, 0, 0.06);
}

@media (min-width: 640px) {
  .search-header {
    padding: 24px;
    border-radius: 16px;
  }
}

@media (min-width: 768px) {
  .search-header {
    padding: 32px;
  }
}

.search-header-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 24px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.search-info {
  flex: 1;
}

.search-title {
  font-family: 'Playfair Display', serif;
  font-size: clamp(26px, 7vw, 34px);
  font-weight: 600;
  color: #0d0d0f;
  margin-bottom: 8px;
  line-height: 1.3;
  letter-spacing: -0.01em;
}

@media (min-width: 768px) {
  .search-title {
    font-size: 32px;
  }
}

.search-count {
  font-size: 15px;
  color: rgba(13, 13, 15, 0.6);
}

.sort-dropdown {
  display: flex;
  align-items: center;
  gap: 12px;
}

.sort-label {
  font-size: 14px;
  font-weight: 600;
  color: #0d0d0f;
  white-space: nowrap;
}

.sort-select {
  padding: 12px 40px 12px 16px;
  border: 2px solid rgba(13, 13, 15, 0.15);
  border-radius: 50px;
  font-size: 16px; /* Prevents iOS zoom */
  font-weight: 600;
  color: #0d0d0f;
  background: white;
  cursor: pointer;
  transition: all 0.3s ease;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%230d0d0f' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  min-height: 48px; /* Touch target */
}

@media (min-width: 640px) {
  .sort-select {
    padding: 10px 36px 10px 16px;
    font-size: 14px;
    min-height: auto;
  }
}

.sort-select:focus {
  outline: none;
  border-color: rgba(13, 13, 15, 0.25);
  box-shadow: 0 0 0 3px rgba(13, 13, 15, 0.05);
}

/* Active Filters */
.active-filters {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  padding-top: 24px;
  border-top: 1px solid rgba(13, 13, 15, 0.1);
}

.active-filters-label {
  font-size: 14px;
  font-weight: 600;
  color: rgba(13, 13, 15, 0.7);
}

.active-filters-tags {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  flex: 1;
}

.filter-tag {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  background: rgba(13, 13, 15, 0.04);
  border: 1px solid rgba(13, 13, 15, 0.12);
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  color: #0d0d0f;
  cursor: pointer;
  transition: all 0.2s ease;
}

.filter-tag:hover {
  background: rgba(13, 13, 15, 0.08);
  border-color: rgba(13, 13, 15, 0.2);
}

.filter-tag-remove {
  font-size: 18px;
  line-height: 1;
}

.clear-all-filters {
  padding: 6px 14px;
  background: none;
  border: 1px solid rgba(13, 13, 15, 0.12);
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  color: rgba(13, 13, 15, 0.7);
  cursor: pointer;
  transition: all 0.2s ease;
}

.clear-all-filters:hover {
  border-color: rgba(13, 13, 15, 0.25);
  background: rgba(13, 13, 15, 0.02);
  color: #0d0d0f;
}

/* Empty State */
.empty-state {
  background: white;
  border-radius: 12px;
  padding: 80px 40px;
  text-align: center;
  box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
  border: 1px solid rgba(0, 0, 0, 0.06);
}

.empty-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 24px;
  opacity: 0.4;
  color: rgba(13, 13, 15, 0.4);
}

.empty-title {
  font-family: 'Playfair Display', serif;
  font-size: 28px;
  font-weight: 700;
  color: #0d0d0f;
  margin-bottom: 12px;
}

.empty-description {
  font-size: 16px;
  line-height: 1.6;
  color: rgba(13, 13, 15, 0.6);
  max-width: 500px;
  margin: 0 auto 32px;
}

.empty-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
}

/* Products Section */
.products-section {
  background: white;
  border-radius: 12px;
  padding: 32px;
  box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
  border: 1px solid rgba(0, 0, 0, 0.06);
}

.product-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

@media (min-width: 640px) {
  .product-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
}

@media (min-width: 768px) {
  .product-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
  }
}

@media (min-width: 1024px) {
  .product-grid {
    grid-template-columns: repeat(4, 1fr);
    gap: 24px;
  }
}

/* Load More Button */
.load-more-wrapper {
  display: flex;
  justify-content: center;
  padding: 32px 0;
  margin-top: 24px;
}

.load-more-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 14px 32px;
  background: #0d0d0f;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 500;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(13, 13, 15, 0.15);
  min-height: 48px;
}

.load-more-btn:hover:not(:disabled) {
  background: #1a1a1d;
  box-shadow: 0 4px 12px rgba(13, 13, 15, 0.25);
  transform: translateY(-1px);
}

.load-more-btn:active:not(:disabled) {
  transform: translateY(0);
}

.load-more-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.load-more-icon {
  width: 18px;
  height: 18px;
  stroke-width: 2;
  transition: transform 0.2s ease;
}

.load-more-btn.loading .load-more-icon {
  animation: spin 1s linear infinite;
}

.load-more-btn.loading .load-more-text {
  opacity: 0.7;
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* Popular Categories */
.popular-categories {
  background: white;
  border-radius: 12px;
  padding: 32px;
  box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
  border: 1px solid rgba(0, 0, 0, 0.06);
}

.popular-categories-title {
  font-family: 'Playfair Display', serif;
  font-size: 24px;
  font-weight: 700;
  color: #0d0d0f;
  margin-bottom: 24px;
  text-align: center;
}

.categories-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

@media (min-width: 640px) {
  .categories-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}

.category-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  padding: 24px;
  background: rgba(13, 13, 15, 0.02);
  border: 1px solid rgba(13, 13, 15, 0.08);
  border-radius: 12px;
  text-decoration: none;
  transition: all 0.2s ease;
}

.category-card:hover {
  border-color: rgba(13, 13, 15, 0.2);
  background: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
}

.category-card:hover .category-icon {
  color: #0d0d0f;
}

.category-icon {
  width: 32px;
  height: 32px;
  color: rgba(13, 13, 15, 0.6);
  flex-shrink: 0;
}

@media (min-width: 640px) {
  .category-icon {
    width: 40px;
    height: 40px;
  }
}

.category-name {
  font-size: 15px;
  font-weight: 600;
  color: #0d0d0f;
  text-align: center;
}

/* Mobile Optimization - Base 375px */
@media (max-width: 767px) {
  /* Page padding */
  .search-page {
    padding: 24px 0 100px; /* Extra bottom padding for mobile nav */
  }

  /* Layout - Single column on mobile */
  .search-layout {
    gap: 16px;
  }

  /* Sidebar - Hidden by default, will show in drawer */
  .search-sidebar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    background: white;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    overflow-y: auto;
    padding: 16px;
    display: block;
  }

  .search-sidebar.active {
    transform: translateX(0);
  }

  /* Header - Reduced padding */
  .search-header {
    padding: 16px;
    border-radius: 12px;
  }

  /* Title - Smaller on mobile */
  .search-title {
    font-size: 20px !important;
    line-height: 1.3;
    margin-bottom: 6px;
  }

  .search-count {
    font-size: 13px;
  }

  /* Header top - Stack vertically */
  .search-header-top {
    flex-direction: column;
    gap: 16px;
    margin-bottom: 16px;
  }

  .search-info {
    width: 100%;
  }

  /* Sort dropdown - Full width */
  .sort-dropdown {
    width: 100%;
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }

  .sort-label {
    font-size: 13px;
  }

  .sort-select {
    width: 100%;
    padding: 12px 40px 12px 16px;
    font-size: 14px;
  }

  /* Active filters - Better wrapping */
  .active-filters {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
    padding-top: 16px;
  }

  .active-filters-label {
    font-size: 13px;
  }

  .active-filters-tags {
    width: 100%;
  }

  .filter-tag {
    padding: 8px 14px;
    font-size: 12px;
  }

  .clear-all-filters {
    padding: 8px 16px;
    font-size: 12px;
  }

  /* Products section - Reduced padding */
  .products-section {
    padding: 16px;
    border-radius: 12px;
  }

  /* Empty state - More compact */
  .empty-state {
    padding: 40px 20px;
    border-radius: 12px;
  }

  .empty-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
  }

  .empty-title {
    font-size: 22px;
    margin-bottom: 10px;
  }

  .empty-description {
    font-size: 14px;
    margin-bottom: 24px;
  }

  .empty-actions {
    flex-direction: column;
    width: 100%;
  }

  .empty-actions .btn-primary,
  .empty-actions .btn-secondary {
    width: 100%;
    justify-content: center;
  }

  /* Popular categories - Better mobile layout */
  .popular-categories {
    padding: 20px 16px;
    border-radius: 12px;
  }

  .popular-categories-title {
    font-size: 20px;
    margin-bottom: 20px;
  }

  .categories-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .category-card {
    padding: 16px 12px;
    gap: 8px;
  }

  .category-icon {
    font-size: 32px;
  }

  .category-name {
    font-size: 13px;
  }

  /* Load More Button */
  .load-more-wrapper {
    padding: 24px 0;
  }

  .load-more-btn {
    width: 100%;
    justify-content: center;
  }
}

/* Extra small devices - 375px base */
@media (max-width: 400px) {
  .search-header {
    padding: 12px;
  }

  .search-title {
    font-size: 18px !important;
  }

  .sort-select {
    padding: 10px 36px 10px 12px;
    font-size: 13px;
  }

  .products-section {
    padding: 12px;
  }

  .category-card {
    padding: 12px 8px;
  }

  .category-icon {
    font-size: 28px;
  }

  .category-name {
    font-size: 12px;
  }
}

/* Mobile Filter Button (Floating) */
.mobile-filter-btn {
  display: none; /* Hidden by default */
}

.mobile-filter-overlay {
  display: none; /* Hidden by default */
}

@media (max-width: 767px) {
  .mobile-filter-btn {
    display: flex !important; /* Show only on mobile */
    position: fixed;
    bottom: 90px; /* Above bottom nav */
    right: 16px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #0d0d0f;
    color: white;
    border: none;
    box-shadow: 0 4px 20px rgba(13, 13, 15, 0.3);
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1050 !important;
    transition: all 0.2s ease;
    pointer-events: auto;
    -webkit-tap-highlight-color: rgba(13, 13, 15, 0.2);
  }

  .filter-icon {
    width: 24px;
    height: 24px;
    stroke-width: 2;
  }

  .mobile-filter-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 24px rgba(13, 13, 15, 0.4);
    background: #1a1a1d;
  }

  .mobile-filter-btn:active {
    transform: scale(0.95);
    box-shadow: 0 2px 12px rgba(13, 13, 15, 0.3);
  }

  .mobile-filter-overlay {
    display: block; /* Show only on mobile */
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(13, 13, 15, 0.5);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .mobile-filter-overlay.active {
    opacity: 1;
    visibility: visible;
  }
}
</style>

<script>
function changeSorting(sortValue) {
  const url = new URL(window.location.href);
  url.searchParams.set('sort', sortValue);
  url.searchParams.set('page', '1'); // Reset to first page
  window.location.href = url.toString();
}

function removeFilter(filterKey) {
  const url = new URL(window.location.href);
  
  if (filterKey === 'price') {
    url.searchParams.delete('min');
    url.searchParams.delete('max');
  } else {
    url.searchParams.delete(filterKey);
  }
  
  url.searchParams.set('page', '1');
  window.location.href = url.toString();
}

function clearAllFilters() {
  const url = new URL(window.location.href);
  const q = url.searchParams.get('q');
  
  // Keep only the search query
  const newUrl = new URL(window.location.origin + window.location.pathname);
  if (q) {
    newUrl.searchParams.set('q', q);
  }
  
  window.location.href = newUrl.toString();
}

// Mobile filter drawer functions
function toggleFilters() {
  const sidebar = document.getElementById('filterSidebar');
  const overlay = document.getElementById('filterOverlay');
  
  if (sidebar && overlay) {
    const isActive = sidebar.classList.contains('active');
    
    if (isActive) {
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    } else {
      sidebar.classList.add('active');
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  }
}

function closeFilters() {
  const sidebar = document.getElementById('filterSidebar');
  const overlay = document.getElementById('filterOverlay');
  
  if (sidebar && overlay) {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
    document.body.style.overflow = '';
  }
}

// Attach event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log('Search page loaded - initializing mobile filters');
  
  // Filter button click
  const filterBtn = document.getElementById('filterBtn');
  if (filterBtn) {
    console.log('Filter button found');
    filterBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Filter button clicked');
      toggleFilters();
    });
    
    // Also add touch event for better mobile support
    filterBtn.addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Filter button touched');
      toggleFilters();
    });
  } else {
    console.log('Filter button NOT found');
  }
  
  // Overlay click to close
  const overlay = document.getElementById('filterOverlay');
  if (overlay) {
    console.log('Overlay found');
    overlay.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('Overlay clicked');
      closeFilters();
    });
  }
  
  // Close button in sidebar
  const closeBtn = document.getElementById('closeFilterBtn');
  if (closeBtn) {
    console.log('Close button found');
    closeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Close button clicked');
      closeFilters();
    });
  }
});

// Close filters on window resize if screen becomes larger
window.addEventListener('resize', function() {
  if (window.innerWidth > 767) {
    closeFilters();
  }
});

// Load More functionality
(function() {
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  if (!loadMoreBtn) return;

  let isLoading = false;
  let currentPage = parseInt(loadMoreBtn.dataset.page) || 1;
  const totalPages = parseInt(loadMoreBtn.dataset.totalPages) || 1;

  loadMoreBtn.addEventListener('click', function() {
    if (isLoading || currentPage >= totalPages) return;

    isLoading = true;
    loadMoreBtn.classList.add('loading');
    loadMoreBtn.disabled = true;

    // Get current URL parameters
    const url = new URL(window.location.href);
    url.searchParams.set('page', currentPage + 1);

    // Fetch next page
    fetch(url.toString(), {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'Accept': 'text/html'
      }
    })
    .then(response => response.text())
    .then(html => {
      // Create a temporary container to parse the response
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      
      // Find the product grid in the response
      const responseGrid = tempDiv.querySelector('#products-grid-container .product-grid');
      const container = document.getElementById('products-grid-container');
      const existingGrid = container ? container.querySelector('.product-grid') : null;
      let newItemsCount = 0;
      
      if (responseGrid && existingGrid) {
        // Get all product-card elements from the response - these are the NEW items only
        // Use querySelectorAll to get direct children only
        const allCards = responseGrid.querySelectorAll('.product-card');
        const newItems = Array.from(allCards);
        newItemsCount = newItems.length;
        
        // Append each product card to the existing grid
        newItems.forEach(item => {
          // Create a deep clone to avoid any reference issues
          const clonedItem = item.cloneNode(true);
          
          // Verify it's a product-card before appending
          if (clonedItem.classList && clonedItem.classList.contains('product-card')) {
            // Append as a direct child of the grid
            existingGrid.appendChild(clonedItem);
          }
        });
      }
      
      // Check if there are more pages (before cleaning up tempDiv)
      const responseLoadMore = tempDiv.querySelector('#loadMoreBtn');
      
      // Clean up temporary container
      tempDiv.innerHTML = '';
      if (responseLoadMore) {
        currentPage = parseInt(responseLoadMore.dataset.page) || currentPage + 1;
        const newTotalPages = parseInt(responseLoadMore.dataset.totalPages) || totalPages;
        
        if (currentPage >= newTotalPages) {
          // No more pages, hide button
          loadMoreBtn.parentElement.style.display = 'none';
        } else {
          loadMoreBtn.dataset.page = currentPage;
          loadMoreBtn.dataset.totalPages = newTotalPages;
        }
      } else {
        // No more pages
        loadMoreBtn.parentElement.style.display = 'none';
      }

      isLoading = false;
      loadMoreBtn.classList.remove('loading');
      loadMoreBtn.disabled = false;

      // Update URL without reload
      window.history.pushState({}, '', url.toString());

      // Scroll to show newly loaded items (smooth scroll)
      if (newItemsCount > 0 && existingGrid) {
        const allItems = existingGrid.querySelectorAll('.product-card');
        if (allItems.length > 0) {
          const scrollTarget = allItems[allItems.length - newItemsCount];
          if (scrollTarget) {
            setTimeout(() => {
              scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
          }
        }
      }
    })
    .catch(error => {
      console.error('Error loading more items:', error);
      alert('Failed to load more items. Please try again.');
      isLoading = false;
      loadMoreBtn.classList.remove('loading');
      loadMoreBtn.disabled = false;
    });
  });
})();
</script>
