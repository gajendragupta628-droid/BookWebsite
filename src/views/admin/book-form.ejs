<div class="admin-card-header" style="margin-top: 0;">
  <h1 class="admin-card-title" style="font-size: 1.75rem; margin: 0;"><%= book._id ? 'Edit' : 'Add New' %> Book</h1>
  <div class="admin-card-actions">
    <a href="/admin/books" class="admin-btn admin-btn-sm admin-btn-secondary">Back to Books</a>
  </div>
</div>

<% if (typeof flash !== 'undefined' && flash.success && flash.success.length > 0) { %>
  <div class="admin-alert admin-alert-success" style="margin-bottom: 1.5rem;">
    <%= flash.success[0] %>
  </div>
<% } %>

<% if (typeof flash !== 'undefined' && flash.error && flash.error.length > 0) { %>
  <div class="admin-alert admin-alert-danger" style="margin-bottom: 1.5rem;">
    <%= flash.error[0] %>
  </div>
<% } %>

<form method="post" action="<%= book._id ? ('/admin/books/' + book._id) : '/admin/books' %>" enctype="multipart/form-data" class="admin-form" id="bookForm">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">

  <!-- Tabs -->
  <div class="book-form-tabs">
    <button type="button" class="book-form-tab active" data-tab="basic">Basic Info</button>
    <button type="button" class="book-form-tab" data-tab="details">Details</button>
    <button type="button" class="book-form-tab" data-tab="pricing">Pricing & Stock</button>
    <button type="button" class="book-form-tab" data-tab="images">Images</button>
    <button type="button" class="book-form-tab" data-tab="seo">SEO & Metadata</button>
  </div>

  <!-- Tab Content: Basic Information -->
  <div class="book-form-tab-content active" data-tab="basic">
  <div class="admin-card">
    <div class="admin-card-header">
      <div class="admin-card-title">Basic Information</div>
    </div>
    
    <div class="admin-form-grid">
      <div class="admin-form-group">
        <label class="admin-form-label required">Title</label>
          <input type="text" name="title" value="<%= book.title || '' %>" class="admin-form-input" required placeholder="Enter book title" id="bookTitle">
        <span class="admin-form-hint">The main title of the book</span>
          <span class="admin-form-error" id="titleError"></span>
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">Subtitle</label>
        <input type="text" name="subtitle" value="<%= book.subtitle || '' %>" class="admin-form-input" placeholder="Enter subtitle (optional)">
        <span class="admin-form-hint">Optional subtitle for the book</span>
      </div>
    </div>

    <div class="admin-form-group">
      <label class="admin-form-label">Authors</label>
        <div class="author-select-container">
	          <input 
	            type="text" 
	            id="authorSearch" 
	            class="admin-form-input" 
	            placeholder="Search or type author names (comma-separated)"
              data-no-autosubmit="true"
	            autocomplete="off"
	          >
	          <div class="author-suggestions" id="authorSuggestions"></div>
	        </div>
        <span class="admin-form-hint">Enter author names separated by commas, or search from existing authors</span>
        <div class="selected-authors" id="selectedAuthors"></div>
    </div>

    <div class="admin-form-group">
      <label class="admin-form-label">Categories</label>
        <%
          const defaultCategoryNames = [
            'Fantasy',
            'Sci-Fi',
            'Romance',
            'Novel',
            'Mystery',
            'Thriller',
            'Biography',
            'Self-Help',
            'Business',
            'Psychology',
            'History',
            'Philosophy',
            'Poetry',
            'Young Adult',
            'Children',
            'Non-Fiction'
          ];
          const categoryNames = Array.from(new Set([
            ...((categories || []).map(c => c && c.name).filter(Boolean)),
            ...(((book && book.categories) || []).filter(Boolean)),
            ...defaultCategoryNames
          ]));
        %>
        <div class="category-chips" id="categoryChips" aria-label="Categories"></div>
        <select name="categories" multiple class="admin-form-select category-select" id="categorySelect" style="display: none;">
          <% (categoryNames || []).forEach(function(name) { 
            const bookCategories = (book && book.categories) ? book.categories : [];
            const isSelected = bookCategories.includes(name) || bookCategories.some(c => c === name);
          %>
            <option value="<%= name %>" <%= isSelected ? 'selected' : '' %>><%= name %></option>
          <% }) %>
      </select>
      <span class="admin-form-hint">Tap chips to select multiple categories</span>
    </div>

    <div class="admin-form-group">
      <label class="admin-form-label">Summary</label>
        <textarea name="summary" rows="4" class="admin-form-textarea" placeholder="Enter a short summary of the book" maxlength="500"><%= book.summary || '' %></textarea>
        <span class="admin-form-hint">Brief description shown in listings (150-250 characters recommended) <span id="summaryCount">0</span>/500</span>
    </div>

    <div class="admin-form-group">
      <label class="admin-form-label">Full Description</label>
      <textarea name="descriptionHTML" rows="8" class="admin-form-textarea" placeholder="Enter full book description"><%= book.descriptionHTML || '' %></textarea>
        <span class="admin-form-hint">Detailed book description for the product page (HTML allowed)</span>
      </div>
    </div>
  </div>

  <!-- Tab Content: Details -->
  <div class="book-form-tab-content" data-tab="details">
  <div class="admin-card">
    <div class="admin-card-header">
      <div class="admin-card-title">Book Details</div>
    </div>
    
    <div class="admin-form-grid">
      <div class="admin-form-group">
        <label class="admin-form-label">Publisher</label>
        <input type="text" name="publisher" value="<%= book.publisher || '' %>" class="admin-form-input" placeholder="Publisher name">
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">Language</label>
        <select name="language" class="admin-form-select">
          <option value="">-- Select Language --</option>
          <option value="English" <%= book.language === 'English' ? 'selected' : '' %>>English</option>
          <option value="Nepali" <%= book.language === 'Nepali' ? 'selected' : '' %>>Nepali</option>
          <option value="Hindi" <%= book.language === 'Hindi' ? 'selected' : '' %>>Hindi</option>
          <option value="Spanish" <%= book.language === 'Spanish' ? 'selected' : '' %>>Spanish</option>
          <option value="French" <%= book.language === 'French' ? 'selected' : '' %>>French</option>
          <option value="German" <%= book.language === 'German' ? 'selected' : '' %>>German</option>
          <option value="Other" <%= book.language === 'Other' ? 'selected' : '' %>>Other</option>
        </select>
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">Binding</label>
        <select name="binding" class="admin-form-select">
          <option value="">-- Select Binding --</option>
          <option value="Paperback" <%= book.binding === 'Paperback' ? 'selected' : '' %>>Paperback</option>
          <option value="Hardcover" <%= book.binding === 'Hardcover' ? 'selected' : '' %>>Hardcover</option>
          <option value="eBook" <%= book.binding === 'eBook' ? 'selected' : '' %>>eBook</option>
          <option value="Audiobook" <%= book.binding === 'Audiobook' ? 'selected' : '' %>>Audiobook</option>
        </select>
      </div>

        <div class="admin-form-group">
          <label class="admin-form-label">Format</label>
          <select name="format" class="admin-form-select">
            <option value="">-- Select Format --</option>
            <option value="Physical" <%= book.format === 'Physical' ? 'selected' : '' %>>Physical</option>
            <option value="Digital" <%= book.format === 'Digital' ? 'selected' : '' %>>Digital</option>
        </select>
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">Condition</label>
        <select name="condition" class="admin-form-select">
          <option value="">-- Select Condition --</option>
          <option value="new" <%= book.condition === 'new' ? 'selected' : '' %>>New</option>
          <option value="used" <%= book.condition === 'used' ? 'selected' : '' %>>Used</option>
        </select>
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">Pages</label>
          <input type="number" name="pages" value="<%= book.pages || '' %>" class="admin-form-input" placeholder="Number of pages" min="1">
        </div>

        <div class="admin-form-group">
          <label class="admin-form-label">Weight (grams)</label>
          <input type="number" name="weightGrams" value="<%= book.weightGrams || '' %>" class="admin-form-input" placeholder="Weight in grams" min="0" step="1">
        </div>

        <div class="admin-form-group">
          <label class="admin-form-label">Dimensions - Length (cm)</label>
          <input type="number" name="dimensionsL" value="<%= book.dimensions && book.dimensions.L ? book.dimensions.L : '' %>" class="admin-form-input" placeholder="Length" min="0" step="0.1">
        </div>

        <div class="admin-form-group">
          <label class="admin-form-label">Dimensions - Width (cm)</label>
          <input type="number" name="dimensionsW" value="<%= book.dimensions && book.dimensions.W ? book.dimensions.W : '' %>" class="admin-form-input" placeholder="Width" min="0" step="0.1">
        </div>

        <div class="admin-form-group">
          <label class="admin-form-label">Dimensions - Height (cm)</label>
          <input type="number" name="dimensionsH" value="<%= book.dimensions && book.dimensions.H ? book.dimensions.H : '' %>" class="admin-form-input" placeholder="Height" min="0" step="0.1">
        </div>

        <div class="admin-form-group">
          <label class="admin-form-label">Edition</label>
          <input type="text" name="edition" value="<%= book.edition || '' %>" class="admin-form-input" placeholder="e.g., 1st Edition, 2nd Edition">
        </div>

        <div class="admin-form-group">
          <label class="admin-form-label">Series</label>
          <input type="text" name="series" value="<%= book.series || '' %>" class="admin-form-input" placeholder="Series name (if part of a series)">
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">ISBN-10</label>
          <input type="text" name="isbn10" value="<%= book.isbn10 || '' %>" class="admin-form-input" placeholder="10-digit ISBN" pattern="[0-9]{10}">
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">ISBN-13</label>
          <input type="text" name="isbn13" value="<%= book.isbn13 || '' %>" class="admin-form-input" placeholder="13-digit ISBN" pattern="[0-9]{13}">
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">Publication Date</label>
        <input type="date" name="publicationDate" value="<%= book.publicationDate ? new Date(book.publicationDate).toISOString().split('T')[0] : '' %>" class="admin-form-input">
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">SKU</label>
        <input type="text" name="sku" value="<%= book.sku || '' %>" class="admin-form-input" placeholder="Stock Keeping Unit">
      </div>
    </div>
    </div>
  </div>

  <!-- Tab Content: Pricing & Stock -->
  <div class="book-form-tab-content" data-tab="pricing">
    <div class="admin-card">
      <div class="admin-card-header">
        <div class="admin-card-title">Pricing & Stock</div>
    </div>

      <div class="admin-form-grid">
        <div class="admin-form-group">
          <label class="admin-form-label required">Sale Price</label>
          <input type="number" name="priceSale" step="0.01" value="<%= book.priceSale || '' %>" class="admin-form-input" required placeholder="19.99" id="priceSale" min="0">
          <span class="admin-form-hint">Current selling price</span>
          <span class="admin-form-error" id="priceSaleError"></span>
        </div>

        <div class="admin-form-group">
          <label class="admin-form-label">MRP (List Price)</label>
          <input type="number" name="priceMRP" step="0.01" value="<%= book.priceMRP || '' %>" class="admin-form-input" placeholder="29.99" id="priceMRP" min="0">
          <span class="admin-form-hint">Original/list price for discount calculation</span>
    </div>

        <div class="admin-form-group">
          <label class="admin-form-label required">Stock Quantity</label>
          <input type="number" name="stock" value="<%= book.stock || 0 %>" class="admin-form-input" required placeholder="100" id="stock" min="0">
          <span class="admin-form-hint">Available inventory count</span>
          <span class="admin-form-error" id="stockError"></span>
    </div>

    <div class="admin-form-group">
          <label class="admin-form-label">Low Stock Threshold</label>
          <input type="number" name="lowStockThreshold" value="<%= book.lowStockThreshold || 5 %>" class="admin-form-input" placeholder="5" min="0">
          <span class="admin-form-hint">Get alerts when stock falls below this number</span>
        </div>
      </div>

      <div id="discountDisplay" style="margin-top: 1rem; display: none;">
        <div class="admin-alert admin-alert-success">
          <strong>Discount:</strong> <span id="discountPercent">0</span>% off
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Content: Images -->
  <div class="book-form-tab-content" data-tab="images">
  <div class="admin-card">
    <div class="admin-card-header">
      <div class="admin-card-title">Book Images (Upload up to 5 images)</div>
    </div>
    
    <% if (book.images && book.images.length > 0) { %>
      <div class="admin-alert admin-alert-info" style="margin-bottom: 1.5rem;">
        <strong>Current Images:</strong> This book has <%= book.images.length %> image(s) uploaded. Upload new images to replace them.
      </div>
    <% } %>

      <div class="image-upload-grid">
        <% for (let i = 1; i <= 5; i++) { %>
          <div class="image-upload-item">
            <label class="admin-form-label">Image <%= i %><%= i === 1 ? ' (Primary)' : '' %></label>
            <div class="image-upload-box" data-index="<%= i %>">
              <input type="file" name="image<%= i %>" accept="image/*" class="image-input" id="image<%= i %>">
              <div class="image-upload-placeholder">
                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span>Click to upload</span>
    </div>
              <img class="image-preview" style="display: none;" />
    </div>
    </div>
        <% } %>
    </div>

      <div id="imagePreviewContainer" class="image-preview-grid"></div>

    <% if (book.images && book.images.length > 0) { %>
      <div style="margin-top: 1.5rem;">
        <strong>Existing Images:</strong>
          <div class="image-preview-grid" style="margin-top: 1rem;">
            <% book.images.forEach(function(img, idx) { %>
              <div class="existing-image-item">
                <img src="<%= img.src %>" alt="Book image" />
                <div class="image-label">Image <%= idx + 1 %></div>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>
    </div>
  </div>

  <!-- Tab Content: SEO & Metadata -->
  <div class="book-form-tab-content" data-tab="seo">
    <div class="admin-card">
      <div class="admin-card-header">
        <div class="admin-card-title">SEO & Metadata</div>
      </div>
      
      <div class="admin-form-group">
        <label class="admin-form-label">Meta Title</label>
        <input type="text" name="metaTitle" value="<%= book.metaTitle || '' %>" class="admin-form-input" placeholder="SEO title (leave empty to use book title)" maxlength="60">
        <span class="admin-form-hint">Recommended: 50-60 characters <span id="metaTitleCount">0</span>/60</span>
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">Meta Description</label>
        <textarea name="metaDescription" rows="3" class="admin-form-textarea" placeholder="SEO description" maxlength="160"><%= book.metaDescription || '' %></textarea>
        <span class="admin-form-hint">Recommended: 150-160 characters <span id="metaDescriptionCount">0</span>/160</span>
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">Tags</label>
        <input type="text" name="tags" value="<%= (book.tags || []).join(', ') %>" class="admin-form-input" placeholder="motivation, self-help, success">
        <span class="admin-form-hint">Comma-separated tags for better searchability</span>
      </div>

      <div class="admin-form-group">
        <label class="admin-form-label">
          <input type="checkbox" name="featured" value="true" <%= book.featured ? 'checked' : '' %> style="margin-right: 0.5rem;">
          Featured Book
        </label>
        <span class="admin-form-hint">Show this book in featured sections</span>
      </div>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="admin-card">
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
      <button type="submit" class="admin-btn admin-btn-primary admin-btn-lg">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <%= book._id ? 'Update' : 'Add' %> Book
      </button>
      
      <a href="/admin/books" class="admin-btn admin-btn-secondary">Cancel</a>
    </div>
  </div>
</form>

<% if (book._id) { %>
  <div class="admin-card">
    <div style="display: flex; justify-content: flex-end;">
      <form action="/admin/books/<%= book._id %>/delete" method="post" style="margin: 0;" onsubmit="return confirm('Are you sure you want to delete this book? This action cannot be undone.')">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit" class="admin-btn admin-btn-danger">
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Delete Book
        </button>
      </form>
    </div>
  </div>
<% } %>

<div id="authorsData" data-authors='<%- JSON.stringify((authors || []).map(a => ({ _id: a._id ? a._id.toString() : '', name: a.name || '', slug: a.slug || '' }))) %>' style="display: none;"></div>
<script src="/public/js/admin-book-form.js"></script>
<script>
  // Load authors from data attribute
  const authorsDataEl = document.getElementById('authorsData');
  if (authorsDataEl) {
    try {
      window.authorsList = JSON.parse(authorsDataEl.dataset.authors || '[]');
    } catch (e) {
      window.authorsList = [];
    }
  } else {
    window.authorsList = [];
  }
</script>
<style>
/* Book Form Tabs */
.book-form-tabs {
  display: flex;
  gap: 0.5rem;
  overflow-x: auto;
  margin-bottom: 1.5rem;
  padding-bottom: 0.5rem;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  border-bottom: 1px solid var(--admin-border);
}

.book-form-tabs::-webkit-scrollbar {
  display: none;
}

.book-form-tab {
  padding: 0.75rem 1.25rem;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--admin-text-muted);
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  transition: var(--admin-transition);
  min-height: 44px;
  font-family: inherit;
}

.book-form-tab:hover {
  color: var(--admin-text);
}

.book-form-tab.active {
  color: var(--admin-primary);
  border-bottom-color: var(--admin-primary);
}

.book-form-tab-content {
  display: none;
}

.book-form-tab-content.active {
  display: block;
}

/* Author Selection */
.author-select-container {
  position: relative;
  margin-bottom: 0.5rem;
}

.author-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: var(--admin-card);
  border: 1px solid var(--admin-border);
  border-radius: 0.5rem;
  margin-top: 0.25rem;
  max-height: 200px;
  overflow-y: auto;
  z-index: 100;
  display: none;
}

.author-suggestions.active {
  display: block;
}

.author-suggestion-item {
  padding: 0.75rem 1rem;
  cursor: pointer;
  transition: var(--admin-transition);
  border-bottom: 1px solid var(--admin-border);
}

.author-suggestion-item:last-child {
  border-bottom: none;
}

.author-suggestion-item:hover {
  background: var(--admin-hover);
}

.selected-authors {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.author-tag {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.375rem 0.75rem;
  background: var(--admin-primary);
  color: #000;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-weight: 500;
}

.author-tag-remove {
  cursor: pointer;
  padding: 0.125rem;
  border-radius: 0.25rem;
  transition: var(--admin-transition);
}

.author-tag-remove:hover {
  background: rgba(0, 0, 0, 0.1);
}

/* Category chips */
.category-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  padding: 0.75rem;
  border: 1px solid var(--admin-border);
  border-radius: 0.5rem;
  background: white;
}

.category-chip {
  appearance: none;
  border: 1px solid var(--admin-border);
  background: var(--admin-hover);
  color: var(--admin-text);
  padding: 0.375rem 0.625rem;
  border-radius: 999px;
  font-size: 0.8125rem;
  cursor: pointer;
  transition: var(--admin-transition);
}

.category-chip:hover {
  border-color: rgba(0, 0, 0, 0.25);
}

.category-chip[data-selected] {
  background: rgba(0, 0, 0, 0.08);
  border-color: rgba(0, 0, 0, 0.35);
  font-weight: 600;
  color: #000;
}

/* Image Upload */
.image-upload-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.image-upload-box {
  position: relative;
  aspect-ratio: 2/3;
  border: 2px dashed var(--admin-border);
  border-radius: 0.5rem;
  overflow: hidden;
  cursor: pointer;
  transition: var(--admin-transition);
  background: var(--admin-hover);
}

.image-upload-box:hover {
  border-color: var(--admin-primary);
}

.image-upload-box input[type="file"] {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
  width: 100%;
  height: 100%;
}

.image-upload-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  color: var(--admin-text-muted);
}

.image-preview {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.image-preview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 1rem;
}

.existing-image-item {
  position: relative;
  aspect-ratio: 2/3;
  border-radius: 0.5rem;
  overflow: hidden;
  border: 1px solid var(--admin-border);
}

.existing-image-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.image-label {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 0.5rem;
  text-align: center;
  font-size: 0.75rem;
}

.admin-form-error {
  display: block;
  color: var(--admin-danger);
  font-size: 0.75rem;
  margin-top: 0.25rem;
  display: none;
}

.admin-form-error.show {
  display: block;
}

@media (max-width: 768px) {
  .image-upload-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.75rem;
  }

  .book-form-tabs {
    gap: 0.25rem;
  }

  .book-form-tab {
    padding: 0.625rem 1rem;
    font-size: 0.8125rem;
  }
}
</style>
